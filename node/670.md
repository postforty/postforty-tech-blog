# 마크다운 테이블 파싱이 안 될 때: 줄바꿈 문자의 함정

## 문제 상황

Node.js로 마크다운을 HTML로 변환하는 프로젝트를 진행하던 중, 이상한 문제에 부딪힌 적이 있다. 분명히 올바른 마크다운 테이블 문법으로 작성했는데, 정규식이 테이블을 인식하지 못하는 상황이었다.

```markdown
| 기능     | 설명        |
| -------- | ----------- |
| 로그인   | 사용자 인증 |
| 대시보드 | 메인 화면   |
```

위와 같은 완벽한 테이블이 있는데도 불구하고, 다음과 같은 정규식이 매칭되지 않았다:

```javascript
const tableRegex = /((?:^\|.*\|$\n)+)/gm;
const match = markdown.match(tableRegex);
console.log(match); // null 😱
```

## 원인 분석

문제의 핵심은 **줄바꿈 문자**에 있었다.

### 운영체제별 줄바꿈 문자

- **Windows**: `\r\n` (Carriage Return + Line Feed)
- **Unix/Linux/Mac**: `\n` (Line Feed)

### 실제 파일 내용

Windows에서 작성된 마크다운 파일의 실제 내용은 다음과 같다:

```
| 기능 | 설명 |\r\n
| --- | --- |\r\n
| 로그인 | 사용자 인증 |\r\n
```

하지만 정규식은 `\n`만 찾고 있었다:

```javascript
/((?:^\|.*\|$\n)+)/gm; // \n만 매칭
```

## 디버깅 과정

문제를 발견하기 위해 `JSON.stringify()`를 사용한 적이 있다:

```javascript
console.log("파일 내용:", JSON.stringify(markdown.substring(0, 100)));
// 출력: "| 기능 | 설명 |\r\n| --- | --- |\r\n"
```

이제 숨겨진 `\r` 문자를 확인할 수 있었다.

## 해결 방법

### 1. 줄바꿈 문자 통일

```javascript
// 모든 줄바꿈을 Unix 스타일로 통일
markdown = markdown.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
```

### 2. 개선된 정규식

```javascript
// 줄 끝의 공백이나 탭도 처리
const tableRegex = /((?:^\|.*\|[ \t]*\n)+)/gm;
```

### 3. 완전한 해결책

```javascript
function parseMarkdownTable(markdown) {
  // 1. 줄바꿈 문자 통일
  const normalizedMarkdown = markdown
    .replace(/\r\n/g, "\n")
    .replace(/\r/g, "\n");

  // 2. 테이블 매칭
  const tableRegex = /((?:^\|.*\|[ \t]*\n)+)/gm;

  return normalizedMarkdown.replace(tableRegex, (match) => {
    const lines = match.trim().split("\n");

    // 구분자 라인 확인
    if (lines.length >= 2 && lines[1].match(/^\|[\s\-:|]+\|$/)) {
      return convertToHtmlTable(match);
    }

    return match;
  });
}
```

## 실제 예제

### Before (실패)

```javascript
const markdown = "| A | B |\r\n| --- | --- |\r\n| 1 | 2 |\r\n";
const regex = /^\|.*\|$/gm;
console.log(markdown.match(regex)); // null
```

### After (성공)

```javascript
const markdown = "| A | B |\r\n| --- | --- |\r\n| 1 | 2 |\r\n";
const normalized = markdown.replace(/\r\n/g, "\n");
const regex = /^\|.*\|$/gm;
console.log(normalized.match(regex)); // ['| A | B |', '| --- | --- |', '| 1 | 2 |']
```

## 교훈

### 1. 크로스 플랫폼 호환성 고려

텍스트 처리 시 항상 줄바꿈 문자를 통일하는 습관을 들여야 한다:

```javascript
// 파일을 읽은 직후 바로 정규화
const content = fs
  .readFileSync(filePath, "utf8")
  .replace(/\r\n/g, "\n")
  .replace(/\r/g, "\n");
```

### 2. 디버깅 팁

보이지 않는 문자를 확인하려면 `JSON.stringify()`를 활용해야 한다:

```javascript
console.log("실제 내용:", JSON.stringify(text));
```

### 3. 정규식 작성 시 주의사항

- 실제 데이터 형태를 정확히 파악해야 한다
- 공백, 탭, 줄바꿈 등 화이트스페이스 문자를 고려해야 한다
- 크로스 플랫폼 환경에서 테스트해야 한다

## 결론

겉으로는 똑같아 보이는 텍스트도 내부적으로는 다른 문자를 포함할 수 있다. 특히 줄바꿈 문자는 운영체제마다 다르기 때문에, 텍스트 처리 시 반드시 정규화 과정을 거쳐야 한다.

이런 작은 차이가 큰 문제를 일으킬 수 있으니, 항상 주의 깊게 처리해야 한다!

---
