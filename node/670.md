# 마크다운 테이블 파싱 오류 해결

## 1. 문제 상황 분석

### 1-1. 테이블 파싱 실패 현상

Node.js 환경에서 마크다운을 HTML로 변환하는 과정에서 정규식이 올바른 테이블 문법을 인식하지 못하는 문제가 발생한다. 다음과 같은 표준 마크다운 테이블 문법이 존재함에도 불구하고 파싱이 실패하는 상황이다.

```markdown
| 기능     | 설명        |
| -------- | ----------- |
| 로그인   | 사용자 인증 |
| 대시보드 | 메인 화면   |
```

### 1-2. 정규식 매칭 실패

위의 완전한 테이블 구조에 대해 다음 정규식이 매칭되지 않는 현상이 나타난다.

```javascript
const tableRegex = /((?:^\|.*\|$\n)+)/gm;
const match = markdown.match(tableRegex);
console.log(match); // null 반환
```

## 2. 원인 규명

### 2-1. 줄바꿈 문자의 차이점

문제의 핵심은 운영체제별로 상이한 줄바꿈 문자 체계에 있다.

- **Windows 시스템**: `\r\n` (Carriage Return + Line Feed)
- **Unix/Linux/Mac 시스템**: `\n` (Line Feed)

### 2-2. 실제 파일 내용 구조

Windows 환경에서 작성된 마크다운 파일의 실제 내용은 다음과 같은 형태이다.

```
| 기능 | 설명 |\r\n
| --- | --- |\r\n
| 로그인 | 사용자 인증 |\r\n
```

그러나 정규식은 Unix 스타일의 `\n`만을 대상으로 매칭을 시도한다.

```javascript
/((?:^\|.*\|$\n)+)/gm; // \n만 매칭 대상
```

### 2-3. 디버깅 과정

숨겨진 문자를 확인하기 위해 `JSON.stringify()` 메서드를 활용한다.

```javascript
console.log("파일 내용:", JSON.stringify(markdown.substring(0, 100)));
// 출력 결과: "| 기능 | 설명 |\r\n| --- | --- |\r\n"
```

이를 통해 숨겨진 `\r` 문자의 존재를 확인할 수 있다.

## 3. 해결 방안

### 3-1. 줄바꿈 문자 정규화

모든 줄바꿈 문자를 Unix 스타일로 통일하는 방법이다.

```javascript
// 모든 줄바꿈을 Unix 스타일로 통일
markdown = markdown.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
```

### 3-2. 개선된 정규식 패턴

줄 끝의 공백이나 탭 문자까지 고려한 정규식을 사용한다.

```javascript
// 줄 끝의 공백이나 탭도 처리
const tableRegex = /((?:^\|.*\|[ \t]*\n)+)/gm;
```

### 3-3. 완전한 해결 함수

줄바꿈 문자 정규화와 테이블 매칭을 통합한 완전한 해결책이다.

```javascript
function parseMarkdownTable(markdown) {
  // 1. 줄바꿈 문자 통일
  const normalizedMarkdown = markdown
    .replace(/\r\n/g, "\n")
    .replace(/\r/g, "\n");

  // 2. 테이블 매칭
  const tableRegex = /((?:^\|.*\|[ \t]*\n)+)/gm;

  return normalizedMarkdown.replace(tableRegex, (match) => {
    const lines = match.trim().split("\n");

    // 구분자 라인 확인
    if (lines.length >= 2 && lines[1].match(/^\|[\s\-:|]+\|$/)) {
      return convertToHtmlTable(match);
    }

    return match;
  });
}
```

## 4. 실제 적용 예제

### 4-1. 문제 상황 재현

```javascript
const markdown = "| A | B |\r\n| --- | --- |\r\n| 1 | 2 |\r\n";
const regex = /^\|.*\|$/gm;
console.log(markdown.match(regex)); // null 반환
```

### 4-2. 해결 후 결과

```javascript
const markdown = "| A | B |\r\n| --- | --- |\r\n| 1 | 2 |\r\n";
const normalized = markdown.replace(/\r\n/g, "\n");
const regex = /^\|.*\|$/gm;
console.log(normalized.match(regex)); // ['| A | B |', '| --- | --- |', '| 1 | 2 |'] 반환
```

## 5. 개발 지침

### 5-1. 크로스 플랫폼 호환성 확보

텍스트 처리 시 줄바꿈 문자 통일을 기본 원칙으로 한다.

```javascript
// 파일 읽기 직후 정규화 적용
const content = fs
  .readFileSync(filePath, "utf8")
  .replace(/\r\n/g, "\n")
  .replace(/\r/g, "\n");
```

### 5-2. 디버깅 기법

보이지 않는 문자 확인을 위해 `JSON.stringify()` 메서드를 활용한다.

```javascript
console.log("실제 내용:", JSON.stringify(text));
```

### 5-3. 정규식 작성 원칙

- 실제 데이터 형태의 정확한 파악이 필요하다
- 공백, 탭, 줄바꿈 등 화이트스페이스 문자를 고려해야 한다
- 크로스 플랫폼 환경에서의 테스트가 필수이다

## 6. 결론

동일하게 보이는 텍스트라도 내부적으로는 상이한 문자를 포함할 수 있다. 특히 줄바꿈 문자는 운영체제마다 다른 형태를 가지므로, 텍스트 처리 시 반드시 정규화 과정을 거쳐야 한다. 이러한 세부적인 차이점이 전체 시스템의 오작동을 야기할 수 있으므로, 개발 과정에서 충분한 주의가 필요하다.
