# Let's Encrypt TLS 인증서 발급 및 자동 갱신

Let's Encrypt는 무료로 TLS 인증서를 발급받을 수 있는 인증 기관이다. 본 문서에서는 Ubuntu 환경에서 Nginx 웹서버를 사용하여 Let's Encrypt 인증서를 발급받고 자동 갱신하는 방법을 설명한다.

## 1. Let's Encrypt TLS 인증서 발급

Ubuntu 환경에서 certbot이 설치된 상태를 전제로 하며, Nginx 웹서버를 사용한다. TLS 인증서 발급 과정은 다음과 같다.

### 1-1. 사전 준비사항

Let's Encrypt 설치는 [https://postforty.tistory.com/437](https://postforty.tistory.com/437)을 참조한다.

### 1-2. 인증서 발급 절차

- 리눅스 정보 확인 (선택사항)

```bash
hostnamectl
```

- 기존 인증서 확인 (최초 발급 시 생략 가능)

```bash
certbot certificates
```

- 웹서버 중지

```bash
service nginx stop
```

#### 1-2-1. 포트 사용 상태 확인

- 포트 80 및 443 사용 프로세스 확인

```bash
sudo netstat -tulpn | grep :80
sudo netstat -tulpn | grep :443
```

- 강제 중지 (필요 시)

```bash
sudo pkill -f nginx
```

#### 1-2-2. 인증서 생성

- 도메인별 인증서 발급 (-d 옵션으로 다중 도메인 추가 가능)

```bash
letsencrypt certonly --standalone -d 도메인1 -d 도메인2 -d 도메인3
```

이메일 인증 요구 시 이메일을 입력하고, 모든 질문에 긍정적으로 답변한다.

- 웹서버 재시작

```bash
service nginx start
```

⚠️ "Certbot failed to authenticate some domains (authenticator: standalone). The Certificate Authority reported these problems:" 오류가 발생하는 경우, DNS가 인증서 발급을 시도하는 IP와 연결되어 있는지 확인해야 한다.

[##_Image|kage@cSJ53k/btsFE0Ur7NF/AAAAAAAAAAAAAAAAAAAAACKX6r2UkRVA2vgm5owh1g0kz29_5i259t1GL4jV9P8-/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&amp;expires=1761922799&amp;allow_ip=&amp;allow_referer=&amp;signature=jNXUNsmUb3%2BoA5rKXmWbvmQktZY%3D|CDM|1.3|{"originWidth":833,"originHeight":375,"style":"alignCenter","caption":"[그림 1] 인증서 발급 실패한 경우"}_##]

### 1-3. Nginx 설정 적용

발급받은 인증서를 `/etc/nginx/sites-available/default`에 적용한다.

> 참고 영상: [https://youtu.be/Xah-BtVfHac?feature=shared](https://youtu.be/Xah-BtVfHac?feature=shared)

## 2. 기존 인증서에 도메인 추가

기존에 발급받은 인증서에 새로운 도메인을 추가하는 방법이다.

### 2-1. 도메인 추가 방법

기존 인증서에 도메인을 추가할 때는 `--cert-name` 옵션을 사용하여 기존 인증서 이름을 지정하고, `-d` 옵션에 기존 도메인과 새로 추가할 도메인을 모두 포함해야 한다.

- 웹서버 중지

```bash
service nginx stop
```

- 도메인 추가 (기존 도메인 + 새 도메인을 모두 포함)

```bash
sudo certbot certonly --cert-name 기존인증서명 -d 기존도메인,새도메인
```

예시:

```bash
sudo certbot certonly --cert-name ulsan.abc -d ulsan.abc.com,pohang.abc.com
```

- 웹서버 재시작

```bash
service nginx start
```

### 2-2. 명시적 expand 옵션 사용

`--expand` 옵션을 명시적으로 포함하여 인증서 확장을 명확히 할 수 있다. (결과는 동일함)

```bash
sudo certbot certonly --cert-name ulsan.abc -d ulsan.abc.com,pohang.abc.com --expand
```

### 2-3. 주의사항

- `-d` 옵션에는 기존 도메인과 새로 추가할 도메인을 **모두** 포함해야 한다
- 기존 도메인을 누락하면 해당 도메인에 대한 인증서가 제거될 수 있다
- `--cert-name`은 기존 인증서의 이름을 정확히 지정해야 한다

## 3. 인증서 갱신

### 3-1. 수동 갱신

- 갱신 테스트 (nginx 중지 후 실행)

```bash
service nginx stop
certbot renew --dry-run
```

- 실제 갱신

```bash
certbot renew
```

## 4. 인증서 자동 갱신

Let's Encrypt 인증서는 만료 30일 전부터 갱신이 가능하며, 갱신 가능 횟수는 무제한이다.

### 4-1. crontab 기본 명령어

crontab을 이용하여 인증서를 자동 갱신할 수 있다.

- 목록 조회

```bash
crontab -l
```

- 생성 및 편집

```bash
crontab -e
```

- 삭제

```bash
crontab -r
```

- 실행 로그 확인

```bash
view /var/log/syslog
```

### 4-2. crontab 작성 규칙

crontab 작성 시 시간은 서버의 시간을 고려하여 설정해야 한다.

- 서버 시간 확인

```bash
date
```

[##_Image|kage@bX6mQV/btsDxjawm4l/AAAAAAAAAAAAAAAAAAAAAGvYv_RvkYm6XvhSWN3mr0FpbyHSYEo7KOnKYc9j_xFR/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&amp;expires=1761922799&amp;allow_ip=&amp;allow_referer=&amp;signature=YI4rtfDDO4%2FK0M3lfAFannb8ysM%3D|CDM|1.3|{"originWidth":652,"originHeight":185,"style":"alignCenter","caption":"[그림 2] crontab 규칙"}_##]

갱신 시간은 사용자 요청이 가장 적은 시간대인 월요일 1~3시 사이로 설정하는 것이 권장된다.

#### 4-2-1. crontab 시간 형식

```
분 시 일 월 요일 명령어
```

- 분 (0-59): 실행될 분
- 시 (0-23): 실행될 시간
- 일 (1-31): 실행될 일
- 월 (1-12): 실행될 월
- 요일 (0-7): 실행될 요일 (0과 7은 일요일)

### 4-3. 자동 갱신 설정 예시

매주 월요일 오전 3시에 실행되는 crontab 설정이다.

```bash
0 3 * * 1 /usr/bin/certbot renew --quiet --pre-hook "/usr/sbin/service nginx stop" --post-hook "/usr/sbin/service nginx start"
```

#### 4-3-1. 설정 옵션 설명

- 분 (0): 정확한 시간의 0분에 실행
- 시 (3): 오전 3시에 실행
- 일 (\*): 모든 일에 해당
- 월 (\*): 모든 월에 해당
- 요일 (1): 월요일에 실행 (요일은 0부터 일요일)
- `/usr/bin/certbot renew --quiet`: SSL/TLS 인증서를 갱신하고 출력을 최소화
- `--pre-hook "/usr/sbin/service nginx stop"`: 인증서 갱신 전 Nginx 중지
- `--post-hook "/usr/sbin/service nginx start"`: 인증서 갱신 후 Nginx 재시작

`certbot renew --dry-run` 테스트 시 "unexpected error: Problem binding to port 80: Could not bind to IPv4 or IPv6.. Skipping." 오류가 발생하는 경우 `--pre-hook`, `--post-hook` 옵션을 추가한다.

### 4-4. cron 서비스 재시작

crontab 작성 및 저장 후 cron 서비스를 재시작한다.

```bash
service cron restart
```

> 참고 영상: [https://www.youtube.com/watch?v=CcLL8hx3n0M](https://www.youtube.com/watch?v=CcLL8hx3n0M)

## 5. Let's Encrypt 인증서 제한사항

### 5-1. 도메인 기반 인증

Let's Encrypt 인증서는 도메인 소유권을 확인하는 방식으로 동작한다. DNS 챌린지 또는 HTTP 챌린지를 통해 해당 도메인에 대한 제어 권한이 있음을 증명해야 인증서 발급이 가능하다.

### 5-2. IP 주소 기반 인증서 발급 불가

IP 주소는 도메인 소유권 증명 방식에 적합하지 않기 때문에 IP 주소만으로는 Let's Encrypt 인증서를 발급받을 수 없다.

### 5-3. IP 주소 기반 SSL/TLS 대안

IP 주소에 직접 SSL/TLS를 적용하려면 다음과 같은 방법을 고려할 수 있다:

- 자체 서명(Self-signed) 인증서 사용
- IP 주소 기반 SSL/TLS를 지원하는 상용 인증서 구매

단, 이 경우에도 브라우저 경고 없이 신뢰성을 확보하기는 어렵다.
